<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calificador de Perfiles</title>
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --muted: #1f2937;
      --text: #e5e7eb; --sub: #9ca3af; --brand: #22d3ee; --accent: #a78bfa;
      --ok: #34d399; --warn: #fbbf24; --danger: #f87171; --radius: 16px;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
    a { color: var(--brand); text-decoration: none; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo img { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--brand), var(--accent)); box-shadow: 0 8px 24px rgba(167,139,250,.3); }
    h1 { font-size: 20px; margin:0; letter-spacing:.3px; }
    .nav { display:flex; gap:8px; flex-wrap: wrap; }
    .btn { background: var(--muted); color: var(--text); border: 1px solid #293042; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: .2s; }
    .btn:hover { transform: translateY(-1px); border-color: var(--brand); box-shadow: 0 6px 16px rgba(34,211,238,.18); }
    .btn.primary { background: linear-gradient(135deg, var(--brand), var(--accent)); color: #0b1020; border: none; }
    .btn.danger { background: #3b1f23; border-color: #5b232a; color: #fecaca; }
    .btn.ok { background: #0d1f1a; border-color: #1f3b34; color: #bbf7d0; }
    .btn.small { padding: 6px 10px; border-radius: 10px; font-size: 12px; }
    .panel { background: linear-gradient(180deg, #0c1224, #0a1020); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 18px; box-shadow: inset 0 1px 0 rgba(255,255,255,.03); }
    .grid { display:grid; gap:16px; grid-template-columns: 1fr; }
    @media(min-width: 900px){ .grid.cols-2 { grid-template-columns: 1fr 1fr; }}
    .section-title { font-size: 16px; margin: 6px 0 10px; color: var(--sub); letter-spacing:.3px; }
    label { font-size: 14px; color: var(--sub); display:block; margin-bottom: 6px; }
    input[type="text"], input[type="file"], input[type="search"], textarea, select { width: 100%; background: #0b1224; color: var(--text); border: 1px solid #24304e; border-radius: 10px; padding: 10px; outline: none; }
    input[type="range"] { width: 100%; }
    .row { display:flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .item { background: #0b1220; border: 1px solid #1d2741; border-radius: 14px; padding: 12px; }
    .item h4 { margin: 0 0 10px; font-size: 15px; }
    .muted { color: var(--sub); }
    .thumb { width: 100%; aspect-ratio: 16/9; background: #0c1326; border: 1px dashed #2a3961; border-radius: 10px; display: grid; place-items: center; overflow: hidden; cursor: pointer; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display:block; }
    .thumb.active-paste {
      border-style: solid;
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(34,211,238,.4);
    }
    .list { display: grid; gap: 12px; }
    .card { background: #0b1220; border: 1px solid #1f2a44; border-radius: 14px; padding: 14px; display:flex; justify-content: space-between; align-items: center; gap:12px; }
    .pill { font-size: 12px; background: #0b2130; border: 1px solid #1b3d4e; color: #cdeffd; padding: 4px 8px; border-radius: 999px; }
    .spacer { height: 12px; }
    .hidden { display:none; }
    .hr { height: 1px; background: #1d2741; margin: 10px 0; }

    /* Marca visual de 0 debajo del slider */
    .midline { position: relative; height: 6px; background: #101a33; border: 1px solid #1d2741; border-radius: 999px; margin-top: 8px; }
    .midline::after { content: ''; position: absolute; left: 50%; top: -6px; width: 2px; height: 18px; background: #22d3ee; transform: translateX(-50%); border-radius: 2px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <img src="logo.png" alt="culo">
        </div>
        <h1>Calificador de Perfiles</h1>
      </div>
      <nav class="nav">
        <button class="btn" onclick="go('home')">Inicio</button>
        <button class="btn" onclick="go('create')">Crear nueva</button>
        <button class="btn" onclick="go('sessions')">Ver antiguas</button>
      </nav>
    </header>

    <!-- HOME -->
    <section id="home" class="grid">
      <div class="panel">
        <h2 class="section-title">Bienvenido</h2>
        <p class="muted">Crea una nueva sesión de calificación o abre una guardada. Todo se almacena en tu navegador (localStorage). Podés exportar/compartir como JSON.</p>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn primary" onclick="go('create')">Crear nueva</button>
          <button class="btn" onclick="go('sessions')">Ver antiguas</button>
          <label class="btn" for="importFile">Importar JSON</label>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
        </div>
      </div>

      <div class="panel">
        <h2 class="section-title">¿Cómo funciona?</h2>
        <ol class="muted">
          <li>Asigna un <b>nombre</b> a la sesión.</li>
          <li>Agrega <b>entradas</b> (cada una con un nombre y dos imágenes de referencia: para valor −10 y valor +10).</li>
          <li>Presiona <b>Comenzar</b> y utiliza los <b>sliders −10…+10</b> para puntuar.</li>
          <li>Guarda la sesión y vuelve a abrirla desde <b>Ver antiguas</b>.</li>
          <li>Opcional: <b>Exporta</b> como JSON para compartir, y <b>Importa</b> para cargarlo.</li>
        </ol>
      </div>
    </section>

    <!-- CREATE -->
    <section id="create" class="grid hidden">
      <div class="panel">
        <h2 class="section-title">Nueva sesión</h2>
        <label for="sessionName">Nombre de la sesión</label>
        <input id="sessionName" type="text" placeholder="Ej: Calificación – Amigos 2025" />
      </div>

      <div class="panel">
        <div class="row" style="justify-content: space-between; align-items: baseline;">
          <h2 class="section-title" style="margin:0">Entradas a calificar</h2>
          <button class="btn small" onclick="addEntry()">+ Agregar entrada</button>
        </div>
        <div id="entries" class="list"></div>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn primary" onclick="startRating()">Comenzar</button>
        </div>
      </div>
    </section>

    <!-- RATE -->
    <section id="rate" class="grid hidden">
      <div class="panel">
        <h2 class="section-title">Calificar: <span id="rateSessionName"></span></h2>
        <div id="rateList" class="grid cols-2"></div>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn ok" onclick="saveSession()">Guardar sesión</button>
          <button class="btn" onclick="go('sessions'); listSessions();">Ver antiguas</button>
          <button class="btn" onclick="calcAverage()">Calcular promedio</button>
          <span class="pill" id="avgOut" title="Promedio de la sesión"></span>
        </div>
      </div>
    </section>

    <!-- SESSIONS -->
    <section id="sessions" class="grid hidden">
      <div class="panel">
        <div class="row" style="justify-content: space-between; align-items: baseline;">
          <h2 class="section-title" style="margin:0">Sesiones guardadas</h2>
          <input id="searchSessions" type="search" placeholder="Buscar por nombre..." />
        </div>
        <div id="sessionsList" class="list"></div>
      </div>
    </section>

    <!-- VIEW SESSION -->
    <section id="view" class="grid hidden">
      <div class="panel">
        <div class="row" style="justify-content: space-between; align-items: baseline;">
          <h2 class="section-title" style="margin:0">Sesión: <span id="viewTitle"></span></h2>
          <div class="row">
            <button class="btn" onclick="exportCurrent()">Exportar JSON</button>
            <button class="btn" onclick="editCurrent()">Editar calificaciones</button>
          </div>
        </div>
        <div id="viewList" class="grid cols-2"></div>
      </div>
    </section>
  </div>

  <script>
    // ===== Utilities & Storage =====
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const STORAGE_KEY = 'ratingSessions:v1';

    function loadAll() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }
    function saveAll(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    function go(id){
      ['home','create','rate','sessions','view'].forEach(s => {
        const el = document.getElementById(s);
        if(!el) return;
        if(s===id) el.classList.remove('hidden'); else el.classList.add('hidden');
      });
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // ===== Helpers =====
    function fmt(n){ const x = Number(n)||0; return (x>=0?'+':'') + x.toFixed(1); }

    // ===== Create Flow =====
    let createEntries = [];

    // destino actual para pegar imágenes
    let lastPasteTarget = null; // { idx, key, previewId }

    function setPasteTarget(idx, key) {
      const previewId = key === 'img0' ? `prev0-${idx}` : `prev10-${idx}`;
      lastPasteTarget = { idx, key, previewId };

      // marcar visualmente el recuadro activo
      $$('.thumb').forEach(el => el.classList.remove('active-paste'));
      const el = document.getElementById(previewId);
      if (el) el.classList.add('active-paste');
    }

    function addEntry(prefill) {
      const idx = createEntries.length;
      const entry = { name: '', img0: '', img10: '' };
      if (prefill) Object.assign(entry, prefill);
      createEntries.push(entry);

      const container = document.createElement('div');
      container.className = 'item';
      container.dataset.index = String(idx);
      container.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h4>Entrada #${idx+1}</h4>
          <button class="btn small danger" onclick="removeEntry(${idx})">Eliminar</button>
        </div>
        <label>Nombre</label>
        <input type="text" placeholder="Ej: Perfil A" oninput="updateEntry(${idx}, 'name', this.value)" value="${escapeHtml(entry.name)}" />
        <div class="grid cols-2" style="margin-top:10px;">
          <div>
            <label>Imagen referencia valor −10</label>
            <div class="thumb" id="prev0-${idx}" onclick="setPasteTarget(${idx}, 'img0')">
              ${entry.img0 ? `<img src="${entry.img0}" alt="ref -10" />` : '<span class="muted">Sin imagen</span>'}
            </div>
            <div class="spacer"></div>
            <input type="file" accept="image/*" onchange="readImage(this, ${idx}, 'img0', 'prev0-${idx}')" />
          </div>
          <div>
            <label>Imagen referencia valor +10</label>
            <div class="thumb" id="prev10-${idx}" onclick="setPasteTarget(${idx}, 'img10')">
              ${entry.img10 ? `<img src="${entry.img10}" alt="ref +10" />` : '<span class="muted">Sin imagen</span>'}
            </div>
            <div class="spacer"></div>
            <input type="file" accept="image/*" onchange="readImage(this, ${idx}, 'img10', 'prev10-${idx}')" />
          </div>
        </div>`;
      document.getElementById('entries').appendChild(container);
    }

    function removeEntry(idx){
      createEntries[idx] = null; // mantener índices
      const node = document.querySelector(`.item[data-index="${idx}"]`);
      if(node) node.remove();
    }

    function updateEntry(idx, key, val){
      if (!createEntries[idx]) createEntries[idx] = { name: '', img0: '', img10: '' };
      createEntries[idx][key] = val;
    }

    function readImage(input, idx, key, previewId){
      const file = input.files && input.files[0];
      if(!file) return;
      const fr = new FileReader();
      fr.onload = () => {
        updateEntry(idx, key, fr.result);
        const prev = document.getElementById(previewId);
        if(prev){ prev.innerHTML = `<img alt="preview" src="${fr.result}"/>`; }
      };
      fr.readAsDataURL(file);
    }

    function startRating(){
      const name = $('#sessionName').value.trim();
      if(!name){ alert('Pon un nombre para la sesión.'); return; }
      const entries = createEntries.filter(Boolean).map(e => ({
        name: (e.name||'Entrada'), img0: e.img0||'', img10: e.img10||'', rating: 0
      }));
      if(entries.length===0){ alert('Agrega al menos una entrada.'); return; }
      current = { name, createdAt: new Date().toISOString(), entries };
      buildRateUI();
      go('rate');
    }

    // ===== Rate & View =====
    let current = null; // sesión activa

    function calcAverage(){
      if(!current){ alert('No hay sesión activa.'); return 0; }
      const vals = current.entries.map(e => Number(e.rating || 0));
      const avg = vals.length ? vals.reduce((a,b)=>a+b,0) / vals.length : 0;
      const out = document.getElementById('avgOut');
      if(out) out.textContent = 'Promedio: ' + fmt(avg) + ' / 10';
      else alert('Promedio: ' + fmt(avg) + ' / 10');
      return avg;
    }

    function buildRateUI(){
      $('#rateSessionName').textContent = current?.name || '';
      const wrap = $('#rateList');
      wrap.innerHTML = '';
      current.entries.forEach((e, i) => {
        const card = document.createElement('div');
        card.className = 'item';
        card.innerHTML = `
          <h4>${escapeHtml(e.name)}</h4>
          <div class="grid cols-2">
            <div>
              <label class="muted">Referencia −10</label>
              <div class="thumb">${e.img0 ? `<img src="${e.img0}" alt="ref -10"/>` : '<span class="muted">Sin imagen</span>'}</div>
            </div>
            <div>
              <label class="muted">Referencia +10</label>
              <div class="thumb">${e.img10 ? `<img src="${e.img10}" alt="ref +10"/>` : '<span class="muted">Sin imagen</span>'}</div>
            </div>
          </div>
          <div class="spacer"></div>
          <label>Puntuación: <b id="score-${i}">${fmt(e.rating ?? 0)}</b> / 10</label>
          <input type="range" min="-10" max="10" step="0.1" value="${e.rating ?? 0}" oninput="updateScore(${i}, this.value)" />
          <div class="midline"></div>
        `;
        wrap.appendChild(card);
      });
    }

    function updateScore(i, val){
      current.entries[i].rating = Number(val);
      const out = document.getElementById(`score-${i}`);
      if(out) out.textContent = fmt(val);
    }

    function saveSession(){
      if(!current){ alert('No hay sesión activa.'); return; }
      const all = loadAll();
      let name = current.name;
      // Garantiza nombre único
      const existingNames = new Set(all.map(s => s.name));
      if (existingNames.has(name)) {
        let k = 2;
        while (existingNames.has(`${name} (${k})`)) k++;
        if (!confirm(`Ya existe una sesión llamada "${name}". ¿Guardar como "${name} (${k})"?`)) return;
        current.name = `${name} (${k})`;
      }
      all.push(current);
      saveAll(all);
      alert('Sesión guardada.');
    }

    function listSessions(){
      const q = $('#searchSessions').value?.toLowerCase() || '';
      const all = loadAll();
      const list = $('#sessionsList');
      list.innerHTML = '';
      all
        .filter(s => s.name.toLowerCase().includes(q))
        .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))
        .forEach((s, idx) => {
          const i = document.createElement('div');
          i.className = 'card';
          i.innerHTML = `
            <div>
              <div style="font-weight:700">${escapeHtml(s.name)}</div>
              <div class="muted">${new Date(s.createdAt).toLocaleString()}</div>
            </div>
            <div class="row">
              <span class="pill">${s.entries.length} entradas</span>
              <button class="btn small" onclick="openSession(${idx})">Abrir</button>
              <button class="btn small danger" onclick="deleteSession(${idx})">Eliminar</button>
            </div>`;
          list.appendChild(i);
        });
      if (!list.children.length) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'No hay sesiones guardadas.';
        list.appendChild(empty);
      }
    }

    let viewIndex = -1;
    function openSession(globalIndex){
      const all = loadAll();
      const s = all[globalIndex];
      if(!s){ alert('No encontrado.'); return; }
      viewIndex = globalIndex;
      renderView(s);
      go('view');
    }

    function deleteSession(globalIndex){
      if(!confirm('¿Eliminar esta sesión?')) return;
      const all = loadAll();
      all.splice(globalIndex,1);
      saveAll(all);
      listSessions();
    }

    function renderView(s){
      $('#viewTitle').textContent = s.name;
      const wrap = $('#viewList');
      wrap.innerHTML = '';

      // Promedio general
      const avg = (s.entries && s.entries.length) ? (s.entries.reduce((a,e)=>a+Number(e.rating||0),0)/s.entries.length) : 0;
      const avgCard = document.createElement('div');
      avgCard.className = 'item';
      avgCard.innerHTML = `<div><span class="pill">Promedio: ${fmt(avg)} / 10</span></div>`;
      wrap.appendChild(avgCard);

      // Entradas
      s.entries.forEach((e) => {
        const card = document.createElement('div');
        card.className = 'item';
        card.innerHTML = `
          <h4>${escapeHtml(e.name)}</h4>
          <div class="grid cols-2">
            <div>
              <label class="muted">Referencia −10</label>
              <div class="thumb">${e.img0 ? `<img src="${e.img0}" alt="ref -10"/>` : '<span class="muted">Sin imagen</span>'}</div>
            </div>
            <div>
              <label class="muted">Referencia +10</label>
              <div class="thumb">${e.img10 ? `<img src="${e.img10}" alt="ref +10"/>` : '<span class="muted">Sin imagen</span>'}</div>
            </div>
          </div>
          <div class="spacer"></div>
          <div>Puntuación guardada: <b>${fmt(e.rating ?? 0)}</b> / 10</div>`;
        wrap.appendChild(card);
      });
    }

    function editCurrent(){
      const all = loadAll();
      const s = all[viewIndex];
      if(!s){ alert('No encontrado.'); return; }
      current = JSON.parse(JSON.stringify(s));
      buildRateUI();
      go('rate');
    }

    function exportCurrent(){
      const all = loadAll();
      const s = all[viewIndex];
      if(!s){ alert('No encontrado.'); return; }
      const blob = new Blob([JSON.stringify(s)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(s.name||'sesion')}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    // ===== Import JSON =====
    $('#importFile').addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0];
      if(!f) return;
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const obj = JSON.parse(fr.result);
          if(!obj || !obj.name || !Array.isArray(obj.entries)) throw new Error('Formato inválido');
          const all = loadAll();
          let name = obj.name;
          const names = new Set(all.map(s => s.name));
          if (names.has(name)) {
            let k=2; while(names.has(`${name} (import ${k})`)) k++;
            obj.name = `${name} (import ${k})`;
          }
          all.push(obj);
          saveAll(all);
          alert('Sesión importada.');
        } catch(e){
          alert('No se pudo importar: ' + e.message);
        }
      };
      fr.readAsText(f);
    });

    // ===== Pegar imágenes con Ctrl+V en el recuadro selecccionado =====
    document.addEventListener("paste", function (event) {
      const items = event.clipboardData?.items;
      if (!items) return;

      const imageItem = Array.from(items).find(it => it.type.startsWith("image/"));
      if (!imageItem) return; // no hay imagen

      if (!lastPasteTarget) {
        alert("Primero hacé clic en el recuadro donde querés pegar la imagen.");
        return;
      }

      const file = imageItem.getAsFile();
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        updateEntry(lastPasteTarget.idx, lastPasteTarget.key, reader.result);
        const prev = document.getElementById(lastPasteTarget.previewId);
        if (prev) {
          prev.innerHTML = `<img src="${reader.result}" alt="pasted image"/>`;
        }
      };
      reader.readAsDataURL(file);
    });

    // ===== Nav init =====
    $('#searchSessions').addEventListener('input', listSessions);

    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    // Init to home
    go('home');
  </script>
</body>
</html>
